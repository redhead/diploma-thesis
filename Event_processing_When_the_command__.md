### Event processing

When the command handler successfully finishes, that is after saving or adding the aggregate to the repository, the new events generated by the aggregate are sent to the event bus. To ensure the synchronous, local-JVM, and transactional execution when creating the read model (as per the strategy), the `SimpleEventBus` was used. A number of event handlers are registered to the event bus using Axon's Spring integration support. In all Spring beans, methods annotated with the `@EventHandler` annotation receive the respective events as the first attribute. 

The majority of event handlers created in the refactoring have only one purpose and that is to build the read model the same way as in the original design. This was achieved by moving the original code, which modified the Hibernate entities, from the service layer to the event handlers. As the business logic and invariant rules were already taken care of by the aggregates in the new domain model, the responsibility of event handlers is just to update the Hibernate entities to reflect the changes represented by the events. Let's finish the example of creating a label with the handler for `LabelCreatedEvent` shown in Listing X**reference needed**.

    @EventHandler
    public void createLabel(LabelCreatedEvent event) {
        UserDetails owner = userDao.getReference(event.getOwner().getId());

        Label label = new Label();
        label.setId(event.getId().getId());
        label.setOwner(owner);
        label.setName(event.getName());
        label.setColor(event.getColor());

        labelDao.save(label);
    }

The event handler uses the original Data Access Objects (DAOs) from the data access layer to communicate with the Hibernate ORM. To correctly set up the label's relationship with the owning user, a reference of the `UserDetails` entity is created from the user identifier. The entity is then initialized with the data from the event and with the `UserDetails` entity reference and finally persisted. 

A similar pattern is found in all the other event handlers that build the read model.