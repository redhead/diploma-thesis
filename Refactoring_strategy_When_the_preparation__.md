### Refactoring strategy

When the preparation phase was completed, the actual task of refactoring the domain model and architecture to CQRS and Event Soucring was ready to be started. But before diving into it, a strategy, that would help in the implementation, was thought through carefully.

It was decided to carry out the implementation in small portions, one at a time. Each portion contained functionality regarding one entity, that was subjected to refactoring, through out all the layers, i.e. the service, controller, and data access layers, and the data transfer objects for REST API (called representations).

The strategy was to ensure compatibility with the original design so the process of refactoring was easier and less extreme. This allowed the system to stay in one coherent form without changing the backing infrastructure and the deployment process. That means, that after the refactoring, the back end was still one module without asynchronous execution, messaging systems or read model processors running on different machines.

For the read model built by CQRS, a PostgreSQL database, the very same as in the original design, was used. The read mode was built using the Hibernate ORM in the same way as in the original design. So, the queries for the CQRS and the original design remained more or less unchanged. This allowed me to focus on refactoring of the write side, i.e. creating the domain model, processing of commands, and emitting events (used to build the read model).

Because the system had been rewritten gradually, i.e. CQRS/ES was applied to one domain entity at a time, and by using the same database schema for the read model, the system worked even though it was only partially refactored. The original features that were not refactored yet used the database to process both commands and queries. The refactored features, however, processed the commands by utilizing the new write model build by using Axon Framework, and emitted events were used to build the read model, which was compatible with the original design. So, the database shared the data between both the original implementation for the joint read-write model and the refactored implementation for the CQRS read model only. For simplicity, the schema of the database was altered for the database to act as an event store too.

Another important decision, in the strategy of refactoring to CQRS and ES, was incorporating Test-Driven Development (TDD) into the process. Tests were often written first to reason about the changes, and then continually run in the process of refactoring to ensure the implementation of some feature was correct. These tests were integration tests and were based on the tests written for the original design. The tests followed the following scheme - set up the initial state for the test, dispatch a command, whose processing was under test, and finally assert the correct state of the database (of the read model effectively). Thus, the system was tested as a black box, where a command was an input and the database state was the output. This way it was guaranteed that the read model for CQRS and the joint read-write model for the original design were in the correct state for both implementations to function properly.

Using this strategy, the result of the refactoring was a system based on the CQRS and ES principles, but that used the original database and the transactional, local-JVM, and synchronous execution for its read model the same way as the original design. This strategy was easier for the refactoring to reason about by making small steps and by using tests to ensure the system works as before, which is fundamental in any refactoring. The final state of the refactoring enables the system to easily divide the back end to several modules (or create microservices), integrate message queue systems, asynchronous execution to improve scalability and flexibility. All this can be done just by modifying the Axon Framework configuration and by making changes to the infrastructure and deployment, but the code can remain almost the same.


