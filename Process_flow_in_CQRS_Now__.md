### Process flow in CQRS

Now that the concepts of CQRS were described, let's put the pieces together and see how they work by an example. The whole CQRS design is shown in Figure X**reference needed** in detail.

Let's begin with a command which is sent from the user interface, e.g. "*add a product to user's cart*". The command is received by the application and validated. Then, the command handler for that command is found and called to process the command. The command handler retrieves the aggregate instance that the command targets, e.g. a *Cart*, from a data access object (usually called a repository). A method of the aggregate is invoked by the handler to process the command. The method, for example, adds the product to some internal data representation, or if the product is already in the cart, it updates the product quantity. With each state change, a domain event which describes the state transition is published by the aggregate, e.g "*product added*". Once the command handling is finished, the aggregate is saved to the repository again, and if successful --- i.e. no error was raised during command handling or saving --- the events are sent to the event handlers. The events can be sent to sagas (a special type of an event handler), or other handlers that have some logic to process the event, for example, an event handler can update the view of the cart in the read model database (e.g. it adds the product to the view), another event handler can pass the events to the messaging infrastructure for integration with other systems, etc.